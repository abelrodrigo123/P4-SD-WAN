# Dockerfile, 4GB no tener menos librerias.

FROM ubuntu:22.04

# Desactivar interactividad (evitar preguntas durante instalaci칩n)
ENV DEBIAN_FRONTEND=noninteractive

# Instalar dependencias b치sicas y configurar el entorno
RUN apt-get update && apt-get install -y \
    curl gnupg software-properties-common sudo iproute2 iputils-ping \
    nano lsof net-tools python3 python3-pip  \
    git sudo tmux tcpdump \
    # build-essential libboost-dev libevent-dev \
    #automake cmake libgmp-dev  \
    # libpcap-dev libboost-test-dev libboost-program-options-dev \
    # libboost-system-dev libboost-filesystem-dev libboost-thread-dev \
    # libevent-dev libtool flex bison pkg-config g++ libssl-dev \
    # thrift-compiler libboost-all-dev \
    && rm -rf /var/lib/apt/lists/*  
    
   
# A침adir repositorios para BMv2 y P4C
RUN . /etc/os-release && \
    echo "deb http://download.opensuse.org/repositories/home:/p4lang/xUbuntu_${VERSION_ID}/ /" | tee /etc/apt/sources.list.d/home:p4lang.list && \
    curl -fsSL "https://download.opensuse.org/repositories/home:p4lang/xUbuntu_${VERSION_ID}/Release.key" | gpg --dearmor | tee /etc/apt/trusted.gpg.d/home_p4lang.gpg > /dev/null && \
    apt-get update && \
    apt-get install -y p4lang-bmv2 p4lang-p4c && \
    rm -rf /var/lib/apt/lists/*


# Instalar BMv2 desde el repositorio de GitHub
# RUN git clone https://github.com/p4lang/behavioral-model.git && \
#     cd behavioral-model && \
#     ./install_deps_ubuntu_22.04.sh && \
#     ./autogen.sh && \
#     ./configure && \
#     make && \
#     make install &&\
#     make -j4

# Instalar p4runtime-shell y dependencias de gRPC
RUN pip3 install grpcio==1.44.0 grpcio-tools p4runtime-shell

# Configuraci칩n del directorio de trabajo
WORKDIR /behavioral-model/targets/simple_switch_grpc

# Copiar archivos necesarios para ejecutar el programa P4
COPY my_program.p4 ./
RUN p4c --target bmv2 --arch v1model --p4runtime-files my_program.p4rt.txt my_program.p4

# Copiar scripts
COPY init_switch.sh /usr/local/bin/init_switch.sh
COPY populate_tables.sh /usr/local/bin/populate_tables.sh
RUN chmod +x /usr/local/bin/init_switch.sh /usr/local/bin/populate_tables.sh

# Exponer puertos necesarios
EXPOSE 9090
EXPOSE 9559

# Comando por defecto
CMD ["/bin/bash"]
# CMD ["simple_switch", "--help"]
